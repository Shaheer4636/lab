AWSTemplateFormatVersion: 2010-09-09
Description: SFTP Onboarding CloudFormation Template (Modified for Prefix List Support)

Parameters:
  SFTPUserName:
    Type: String
    Default: sftp-test-demo-user
    Description: Enter the SFTP username.

  SFTPServerId:
    Type: String
    Default: s-11f70be58624e51b
    Description: Enter the AWS Transfer Family server ID.

  SSHPublicKey:
    Type: String
    Default: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCk9shMs0TyVLwR76F..."
    Description: Enter the SSH public key.

  S3KMSKeyId:
    Type: String
    Default: f2a86c18-3b39-4849-b25e-7d8d8ee5c5ba
    Description: Enter the S3 KMS Customer Managed Key ID.

  SFTPS3BucketName:
    Type: String
    Default: test-sftp-bucket-dev-test
    Description: Enter the name of the S3 bucket.

  SFTPSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Enter the SFTP Security Group ID (sftp-security-group-demo-test).

  PartnerIPList:
    Type: CommaDelimitedList
    Default: ["198.51.100.10/32", "203.0.113.20/32", "203.0.113.30/32", "203.0.113.40/32", "203.0.113.50/32"]
    Description: Comma-separated list of partner IP CIDRs to include in the Prefix List.

  PolicyName:
    Type: String
    Default: sftp-s3-access-policy-demo-test
    Description: Name of the permission policy for the role.

Mappings:
  AccountIDMap:
    "344181789061":
      AccountName: HMG-US-Data-Prod
      AccountNameLower: hmg-us-data-prod
    "627992319838":
      AccountName: Test-Account
      AccountNameLower: test-account

Resources:
  PartnerPrefixList:
    Type: AWS::EC2::PrefixList
    Properties:
      AddressFamily: IPv4
      MaxEntries: 20
      PrefixListName: !Sub SFTP-${SFTPUserName}-PrefixList
      Entries:
        Fn::Split:
          - ","
          - !Join [",", !Ref PartnerIPList]

  SFTPUserRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
          - "-"
          -
            - Fn::FindInMap:
                - AccountIDMap
                - Ref: AWS::AccountId
                - AccountName
            - "SFTP-Role"
            - Ref: SFTPUserName
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: transfer.amazonaws.com
            Action: sts:AssumeRole
      Path: "/"
      Policies:
        - PolicyName: !Ref PolicyName
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:Encrypt
                  - kms:DescribeKey
                  - s3:ListBucket
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                Resource:
                  - !Sub arn:aws:s3:::${SFTPS3BucketName}
                  - !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/${S3KMSKeyId}
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub arn:aws:s3:::${SFTPS3BucketName}/home/${SFTPUserName}/*
              - Effect: Allow
                Action:
                  - s3:DeleteObject
                Resource: !Sub arn:aws:s3:::${SFTPS3BucketName}/home/${SFTPUserName}/To/*

  SFTPCustomUser:
    Type: AWS::Transfer::User
    Properties:
      ServerId: !Ref SFTPServerId
      UserName: !Ref SFTPUserName
      HomeDirectoryMappings:
        - Entry: "/"
          Target: !Sub "/${SFTPS3BucketName}/home/${SFTPUserName}"
      HomeDirectoryType: LOGICAL
      Role: !GetAtt SFTPUserRole.Arn
      SshPublicKeys:
        - !Ref SSHPublicKey
      Tags:
        - Key: Name
          Value: !Ref SFTPUserName

  AllowInboundPrefixListRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SFTPSecurityGroupId
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourcePrefixListId: !Ref PartnerPrefixList
