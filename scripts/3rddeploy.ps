#!/usr/bin/env bash
set -euo pipefail

: "${AEM_DEPLOY_URL:?AEM_DEPLOY_URL not set}"
: "${AEM_DEPLOY_USERNAME:?AEM_DEPLOY_USERNAME not set}"
: "${AEM_DEPLOY_PASSWORD:?AEM_DEPLOY_PASSWORD not set}"

AEM_DEPLOY_ARTIFACT_FOLDER="$(System.DefaultWorkingDirectory)/_bsro-aem-shared/zip-artifacts"
RETRIES=3
BACKOFF=30

# Pick ZIP
FILEPATH="$(ls "$AEM_DEPLOY_ARTIFACT_FOLDER"/*.zip -1 2>/dev/null | head -n1 || true)"
if [[ -z "${FILEPATH}" ]]; then
  echo "No ZIP in $AEM_DEPLOY_ARTIFACT_FOLDER"
  exit 0
fi

FILENAME="$(basename "$FILEPATH")"
BASENAME="${FILENAME%.zip}"
REGISTRY="com.bridgestone.bsro.aem"
if [[ "$BASENAME" == xtc* ]]; then
  REGISTRY="bsro_hotfix"
fi

echo "Deploying: $FILENAME (group: $REGISTRY)"

pm_post_success () {
  local url="$1"
  curl -s -u "${AEM_DEPLOY_USERNAME}:${AEM_DEPLOY_PASSWORD}" -X POST "$url" | jq -r '.success'
}

# --- Upload with retries ---
for ((i=1; i<=RETRIES; i++)); do
  echo "Upload attempt $i/$RETRIES"
  curl -s -u "${AEM_DEPLOY_USERNAME}:${AEM_DEPLOY_PASSWORD}" \
       -F "file=@${FILEPATH}" -F "name=${FILENAME}" \
       -F "force=true" -F "install=false" \
       "${AEM_DEPLOY_URL}/crx/packmgr/service.jsp" >/dev/null

  PREVIEW_URL="${AEM_DEPLOY_URL}/crx/packmgr/service/.json/etc/packages/${REGISTRY}/${FILENAME}?cmd=preview"
  EXISTS_REMOTE="$(pm_post_success "$PREVIEW_URL")"
  echo "Preview success: $EXISTS_REMOTE"

  [[ "$EXISTS_REMOTE" == "true" ]] && { echo "Upload OK."; break; }

  if [[ $i -lt $RETRIES ]]; then sleep $((BACKOFF + 10*i)); else
    echo "Upload failed after $RETRIES attempts"; exit 1; fi
done

# --- PauseInstallation cleanup (optional) ---
PAUSE_JSON_URL="${AEM_DEPLOY_URL}/system/sling/installer/jcr/pauseInstallation.1.json"
COUNT_NODES="$(curl -s -u "${AEM_DEPLOY_USERNAME}:${AEM_DEPLOY_PASSWORD}" "$PAUSE_JSON_URL" | jq -r 'keys // [] | length' 2>/dev/null || echo 0)"
echo "pauseInstallation nodes: $COUNT_NODES"
if [[ "$COUNT_NODES" -gt 0 ]]; then
  echo "Deleting pauseInstallation nodeâ€¦"
  curl -s -u "${AEM_DEPLOY_USERNAME}:${AEM_DEPLOY_PASSWORD}" -X DELETE \
       "${AEM_DEPLOY_URL}/system/sling/installer/jcr/pauseInstallation" >/dev/null || true
fi

# --- Install with retries ---
for ((i=1; i<=RETRIES; i++)); do
  echo "Install attempt $i/$RETRIES"
  INSTALL_URL="${AEM_DEPLOY_URL}/crx/packmgr/service/.json/etc/packages/${REGISTRY}/${BASENAME}?cmd=install"
  RESULT="$(pm_post_success "$INSTALL_URL")"
  echo "Install result: $RESULT"

  [[ "$RESULT" == "true" ]] && { echo "Install succeeded."; exit 0; }

  if [[ $i -lt $RETRIES ]]; then sleep $((BACKOFF + 10*i)); else
    echo "Install failed after $RETRIES attempts"; exit 1; fi
done
